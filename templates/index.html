<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI TradingView</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #000000;
            line-height: 1.6;
        }

        /* Header Styles */
        .header { background: #000000; color: #ffffff; padding: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .navbar { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; height: 70px; }
        .logo { display: flex; align-items: center; font-size: 1.5rem; font-weight: 700; gap: 10px; }
        .nav-menu { display: flex; gap: 30px; align-items: center; }
        .nav-item { color: #ffffff; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 6px; transition: all 0.3s ease; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .login-btn, .signup-btn { padding: 8px 20px; border: 2px solid #ffffff; background: transparent; color: #ffffff; border-radius: 6px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; cursor: pointer; }
        .login-btn:hover { background: #ffffff; color: #000000; }
        .signup-btn { background: #ffffff; color: #000000; }
        .signup-btn:hover { background: transparent; color: #ffffff; }
        .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #ffffff; color: #000000; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
        .status-indicator.online { background: #16a085; }

        /* Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }

        /* Utility classes */
        .text-center { text-align: center; }
        .mb-20 { margin-bottom: 20px; }
        .positive { color: #16a085 !important; }
        .negative { color: #e74c3c !important; }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .dashboard-card {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .dashboard-card h3 {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        /* Portfolio Summary Card */
        .portfolio-summary .metric {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .portfolio-summary .metric .label { color: #666; }
        .portfolio-summary .metric .value { font-weight: 600; font-size: 1.3rem; }

        /* Recent Models Card */
        .recent-models ul { list-style: none; }
        .recent-models li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .recent-models li:last-child { border-bottom: none; }
        .recent-models .model-name { font-weight: 600; }
        .recent-models .model-details { font-size: 0.9rem; color: #666; }

        /* Market Overview Styles */
        .market-overview { background: #ffffff; border: 1px solid #e5e5e5; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .stock-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .stock-card { background: #f8f9fa; border: 1px solid #e5e5e5; border-radius: 10px; padding: 20px; transition: all 0.3s ease; }
        .stock-card:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .stock-card .stock-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .stock-card .ticker { font-size: 1.5rem; font-weight: 700; }
        .stock-card .name { font-size: 0.9rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .stock-card .price-info { text-align: right; }
        .stock-card .price { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .stock-card .change { font-size: 1rem; font-weight: 600; }
        .loading-placeholder { text-align: center; padding: 40px; color: #666; grid-column: 1 / -1; }

    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <nav class="navbar">
            <div class="logo"><i class="fas fa-chart-line"></i> AI TradingView</div>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-item">메인</a>
                <a href="{{ url_for('models_page') }}" class="nav-item">모델관리</a>
                <a href="{{ url_for('portfolio_page') }}" class="nav-item">포트폴리오</a>
                <a href="{{ url_for('analysis_page') }}" class="nav-item">분석</a>
                <a href="{{ url_for('stocks_page') }}" class="nav-item">종목보기</a>
            </div>
            <div class="user-menu">
                {% if current_user.is_authenticated %}
                <div class="user-profile" id="userProfile">
                    <a href="{{ url_for('profile') }}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 10px;">
                        <div class="status-indicator online"></div>
                        <div class="avatar">{{ current_user.name[0] }}</div>
                        <span>안녕하세요, {{ current_user.name }}님</span>
                    </a>
                    <a href="{{ url_for('logout') }}" class="login-btn">로그아웃</a>
                </div>
                {% else %}
                <div id="authButtons">
                    <a href="{{ url_for('login') }}" class="login-btn">로그인</a>
                    <a href="{{ url_for('register') }}" class="signup-btn">회원가입</a>
                </div>
                {% endif %}
            </div>
        </nav>
    </div>

    <div class="container">
        <div class="market-overview">
            <h2 class="text-center mb-20">실시간 시장 현황 (즐겨찾기)</h2>
            <div id="stockCardsContainer" class="stock-cards">
                <div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> 주요 시세 정보를 불러오는 중입니다...</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card portfolio-summary">
                <h3><i class="fas fa-wallet"></i> 내 포트폴리오 요약</h3>
                <div id="portfolioSummaryContent">
                    <div class="loading-placeholder">데이터를 불러오는 중...</div>
                </div>
            </div>
            <div class="dashboard-card recent-models">
                <h3><i class="fas fa-brain"></i> 최근 학습 모델</h3>
                <div id="recentModelsContent">
                    <div class="loading-placeholder">데이터를 불러오는 중...</div>
                </div>
            </div>
            <div class="dashboard-card exchange-rate-chart">
                <h3><i class="fas fa-chart-area"></i> 환율 변동 추이 (30일)</h3>
                <p id="currentRateDisplay" style="text-align: center; font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; height: 24px;">-</p>
                <div id="exchangeRateChartContent" style="height: 250px;">
                    <canvas id="rateChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let exchangeRate = null;

            const formatCurrency = (value, currency = 'USD') => {
                if (typeof value !== 'number' || isNaN(value)) return '-';
                if (currency === 'KRW') {
                    return `₩${value.toLocaleString('ko-KR', { maximumFractionDigits: 0 })}`;
                }
                return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };

            // --- Load Latest Exchange Rate for other cards ---
            const loadLatestRate = () => {
                const savedRateData = localStorage.getItem('usdToKrwRateData');
                if (savedRateData) {
                    const { rate } = JSON.parse(savedRateData);
                    exchangeRate = rate;
                } 
            };
            loadLatestRate();

            // --- Market Overview (Favorites) ---
            const stockCardsContainer = document.getElementById('stockCardsContainer');
            fetch('/api/market_overview')
                .then(response => response.json())
                .then(data => {
                    stockCardsContainer.innerHTML = '';
                    if (data && data.length > 0) {
                        data.forEach(stock => {
                            const changeClass = stock.change >= 0 ? 'positive' : 'negative';
                            const sign = stock.change >= 0 ? '+' : '';
                            const price = typeof stock.price === 'number' ? `$${stock.price.toFixed(2)}` : 'N/A';
                            let changeHtml = 'N/A';
                            if (typeof stock.change === 'number') {
                                changeHtml = `<div class="change ${changeClass}">${sign}${stock.change.toFixed(2)} (${sign}${stock.percent_change.toFixed(2)}%)</div>`;
                            }
                            const card = document.createElement('div');
                            card.className = 'stock-card';
                            card.innerHTML = `
                                <div class="stock-header">
                                    <div>
                                        <div class="ticker">${stock.ticker}</div>
                                        <div class="name">${stock.name}</div>
                                    </div>
                                    <div class="price-info">
                                        <div class="price">${price}</div>
                                        ${changeHtml}
                                    </div>
                                </div>
                            `;
                            stockCardsContainer.appendChild(card);
                        });
                    } else {
                        stockCardsContainer.innerHTML = `<div class="loading-placeholder">즐겨찾기한 종목이 없습니다. <a href="{{ url_for('stocks_page') }}">종목보기</a> 페이지에서 관심 종목을 추가해주세요.</div>`;
                    }
                }).catch(error => {
                    console.error('Error fetching market overview:', error);
                    stockCardsContainer.innerHTML = '<div class="loading-placeholder">오류가 발생했습니다.</div>';
                });

            // --- Portfolio Summary ---
            const portfolioSummaryContent = document.getElementById('portfolioSummaryContent');
            fetch('/api/portfolio/summary')
                .then(response => response.json())
                .then(holdings => {
                    if (holdings.error) throw new Error(holdings.error);
                    let totalPortfolioValue = 0;
                    let totalInvestedValue = 0;
                    holdings.forEach(h => {
                        const currentValue = (h.current_price && h.quantity) ? h.current_price * h.quantity : 0;
                        totalPortfolioValue += currentValue;
                        totalInvestedValue += h.average_cost * h.quantity;
                    });
                    const totalGainLoss = totalPortfolioValue - totalInvestedValue;
                    
                    portfolioSummaryContent.innerHTML = `
                        <div class="metric">
                            <span class="label">총 자산</span>
                            <span class="value">${formatCurrency(totalPortfolioValue)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">총 손익</span>
                            <span class="value ${totalGainLoss >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalGainLoss)}</span>
                        </div>
                    `;
                }).catch(error => {
                    portfolioSummaryContent.innerHTML = '<div class="loading-placeholder">포트폴리오 요약 정보를 불러오는 데 실패했습니다.</div>';
                });

            // --- Recent Models ---
            const recentModelsContent = document.getElementById('recentModelsContent');
            fetch('/model')
                .then(response => response.json())
                .then(models => {
                    if (models.error) throw new Error(models.error);
                    if (models && models.length > 0) {
                        const modelsList = document.createElement('ul');
                        models.slice(0, 3).forEach(model => {
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <div>
                                    <div class="model-name">${model.filename}</div>
                                    <div class="model-details">종목: ${model.symbol} | 생성일: ${new Date(model.created_date).toLocaleDateString('ko-KR')}</div>
                                </div>
                                <a href="{{ url_for('models_page') }}" style="font-size: 0.9rem;">관리</a>
                            `;
                            modelsList.appendChild(li);
                        });
                        recentModelsContent.innerHTML = '';
                        recentModelsContent.appendChild(modelsList);
                    } else {
                        recentModelsContent.innerHTML = '<div class="loading-placeholder">아직 학습된 모델이 없습니다. <a href="{{ url_for('models_page') }}">모델관리</a> 페이지에서 새 모델을 학습시켜 보세요.</div>';
                    }
                }).catch(error => {
                    recentModelsContent.innerHTML = '<div class="loading-placeholder">모델 정보를 불러오는 데 실패했습니다.</div>';
                });

            // --- Exchange Rate Chart ---
            const renderExchangeRateChart = (labels, data) => {
                const ctx = document.getElementById('rateChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'USD/KRW 환율',
                            data: data,
                            borderColor: '#4e73df',
                            backgroundColor: 'rgba(78, 115, 223, 0.05)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                },
                                ticks: { display: false },
                                grid: { display: false }
                            },
                            y: {
                                ticks: { padding: 10 },
                                grid: { color: '#f0f0f0' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            };

            const fetchHistoricalRate = () => {
                const currentRateDisplay = document.getElementById('currentRateDisplay');
                currentRateDisplay.textContent = '조회 중...';

                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 30);
                const formatDate = (date) => date.toISOString().split('T')[0];

                const url = `https://api.frankfurter.app/${formatDate(startDate)}..${formatDate(endDate)}?from=USD&to=KRW`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const rates = data.rates;
                        const sortedDates = Object.keys(rates).sort((a, b) => new Date(a) - new Date(b));
                        const labels = sortedDates;
                        const chartData = sortedDates.map(date => rates[date].KRW);
                        renderExchangeRateChart(labels, chartData);

                        // Save and display the latest rate
                        const latestRate = chartData[chartData.length - 1];
                        currentRateDisplay.textContent = `현재 환율: 1 USD = ${latestRate.toFixed(2)} KRW`;
                        
                        const rateData = { rate: latestRate, timestamp: new Date().getTime() };
                        localStorage.setItem('usdToKrwRateData', JSON.stringify(rateData));
                        exchangeRate = latestRate;

                    }).catch(error => {
                        console.error('Failed to fetch historical exchange rate:', error);
                        document.getElementById('exchangeRateChartContent').innerHTML = '<div class="loading-placeholder">차트 로딩 실패</div>';
                        currentRateDisplay.textContent = '환율 조회 실패';
                    });
            };

            fetchHistoricalRate();
        });
    </script>
</body>
</html>