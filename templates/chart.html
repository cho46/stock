<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ê¸‰ ì°¨íŠ¸ ë¶„ì„ ë„êµ¬ (ìì„ ê¸°ëŠ¥)</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        .container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        .header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        .tool-group {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .btn {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            border: 1px solid rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn.magnet {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            position: relative;
        }
        .btn.magnet::after {
            content: '';
            position: absolute;
            top: 2px; right: 2px;
            width: 8px; height: 8px;
            background: #f39c12;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }
        #chartDiv {
            flex-grow: 1;
            background: rgba(255,255,255,0.95);
            margin: 10px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .status-bar {
            padding: 8px 20px;
            background: rgba(255,255,255,0.9);
            border-top: 1px solid rgba(0,0,0,0.1);
            font-size: 0.85rem;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .magnet-indicator {
            position: absolute;
            width: 12px;
            height: 12px;
            border: 2px solid #e74c3c;
            border-radius: 50%;
            background: rgba(231, 76, 60, 0.2);
            pointer-events: none;
            z-index: 1000;
            display: none;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ì°¨íŠ¸ ë¶„ì„ ë„êµ¬</h1>
            <div class="toolbar">
                <div class="tool-group">
                    <button id="toggleAIBtn" class="btn active" title="AI ë¶„ì„ í‘œì‹œ/ìˆ¨ê¸°ê¸°"><i class="fas fa-robot"></i> AI ë¶„ì„</button>
                </div>
                <div class="tool-group">
                    <button class="btn range-btn" data-range="1m">1M</button>
                    <button class="btn range-btn" data-range="3m">3M</button>
                    <button class="btn range-btn" data-range="6m">6M</button>
                    <button class="btn range-btn" data-range="1y">1Y</button>
                    <button class="btn range-btn active" data-range="all">All</button>
                </div>
                <div class="tool-group">
                    <button id="magnetBtn" class="btn magnet active" title="ìì„ ê¸°ëŠ¥ (ìº”ë“¤ì— ìë™ ë¶™ê¸°)">
                        <i class="fas fa-magnet"></i> ìì„
                    </button>
                </div>

                <div class="tool-group">
                    <button id="tool-trendline" class="btn tool-btn" title="ì¶”ì„¸ì„ "><i class="fas fa-chart-line"></i> ì¶”ì„¸ì„ </button>
                    <button id="tool-horizontal" class="btn tool-btn" title="ìˆ˜í‰ì„ "><i class="fas fa-minus"></i> ìˆ˜í‰ì„ </button>
                    <button id="tool-vertical" class="btn tool-btn" title="ìˆ˜ì§ì„ "><i class="fas fa-grip-lines-vertical"></i> ìˆ˜ì§ì„ </button>
                </div>

                <div class="tool-group">
                    <button id="tool-fibonacci" class="btn tool-btn" title="í”¼ë³´ë‚˜ì¹˜ ë˜ëŒë¦¼"><i class="fas fa-wave-square"></i> í”¼ë³´ë‚˜ì¹˜</button>
                    <button id="tool-fibonacci-ext" class="btn tool-btn" title="í”¼ë³´ë‚˜ì¹˜ í™•ì¥"><i class="fas fa-expand-arrows-alt"></i> í”¼ë³´ í™•ì¥</button>
                </div>

                <div class="tool-group">
                    <button id="tool-rectangle" class="btn tool-btn" title="ì‚¬ê°í˜•"><i class="fas fa-square"></i> ì‚¬ê°í˜•</button>
                    <button id="tool-channel" class="btn tool-btn" title="ì±„ë„"><i class="fas fa-arrows-alt-v"></i> ì±„ë„</button>
                </div>

                <div class="tool-group">
                    <button id="tool-text" class="btn tool-btn" title="í…ìŠ¤íŠ¸"><i class="fas fa-font"></i> í…ìŠ¤íŠ¸</button>
                    <button id="tool-arrow" class="btn tool-btn" title="í™”ì‚´í‘œ"><i class="fas fa-arrow-right"></i> í™”ì‚´í‘œ</button>
                </div>

                <div class="tool-group">
                    <button id="undoBtn" class="btn" title="ë˜ëŒë¦¬ê¸°"><i class="fas fa-undo"></i> ë˜ëŒë¦¬ê¸°</button>
                    <button id="clearBtn" class="btn danger" title="ëª¨ë‘ ì§€ìš°ê¸°"><i class="fas fa-trash"></i> ì§€ìš°ê¸°</button>
                </div>
            </div>
        </div>

        <div id="chartDiv"></div>

        <div class="status-bar">
            <div id="coordinates">ë§ˆìš°ìŠ¤ë¥¼ ì°¨íŠ¸ì— ì˜¬ë ¤ë³´ì„¸ìš”</div>
            <div id="tool-status">ë„êµ¬ë¥¼ ì„ íƒí•˜ì—¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”</div>
        </div>
    </div>

    <div class="magnet-indicator" id="magnetIndicator"></div>

    <script>
        const chartDiv = document.getElementById('chartDiv');
        const toolButtons = document.querySelectorAll('.tool-btn');

        let layout = {};
        let chartData = {};
        let data = [];
        
        let isAIVisible = true;
        let magnetEnabled = true;
        let currentTool = null;
        let drawingIdCounter = 0;
        let relayoutTimeout = null;

        const fiboLevels = [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1];
        const fiboExtLevels = [1, 1.236, 1.382, 1.5, 1.618, 2, 2.618];
        const fiboColors = ['#787878', '#E41A1C', '#377EB8', '#4DAF4A', '#984EA3', '#FF7F00', '#FFD700'];

        async function initializeChart(symbol, modelName) {
            const statusElement = document.getElementById('tool-status');
            statusElement.textContent = `'${symbol}'ì— ëŒ€í•œ AI ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...`;
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        model_name: modelName,
                        period: '2y',
                        initial_balance: 10000
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`);
                }

                const analysisResult = await response.json();
                if (analysisResult.error) throw new Error(analysisResult.error);

                chartData = analysisResult.chart_data;
                drawChart(analysisResult);

            } catch (error) {
                console.error('ì°¨íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                chartDiv.innerHTML = `<p style="padding: 20px; color: red;">ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            }
        }

        function drawChart(analysisResult) {
            const candlestickTrace = {
                x: chartData.dates, open: chartData.open, high: chartData.high, low: chartData.low, close: chartData.close,
                type: 'candlestick', name: 'ì£¼ê°€', xaxis: 'x', yaxis: 'y1'
            };
            const portfolioTrace = {
                x: chartData.dates, y: chartData.portfolio, type: 'scatter', mode: 'lines', name: 'AI ì „ëµ',
                line: { color: '#667eea', width: 2 }, xaxis: 'x', yaxis: 'y2'
            };
            const benchmarkTrace = {
                x: chartData.dates, y: chartData.benchmark, type: 'scatter', mode: 'lines', name: 'ë²¤ì¹˜ë§ˆí¬',
                line: { color: '#f5a623', width: 2 }, xaxis: 'x', yaxis: 'y2'
            };

            layout = {
                title: { text: `${analysisResult.symbol} ìƒì„¸ ë¶„ì„`, font: { size: 20, color: '#2c3e50' } },
                xaxis: { domain: [0, 1], anchor: 'y2', rangeslider: { visible: false }, showgrid: true, gridcolor: 'rgba(0,0,0,0.1)' },
                yaxis: { domain: [0.3, 1], title: 'ì£¼ê°€', showgrid: true, gridcolor: 'rgba(0,0,0,0.1)' },
                yaxis2: { domain: [0, 0.25], title: 'í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜', showgrid: true, gridcolor: 'rgba(0,0,0,0.1)' },
                shapes: [], annotations: [], dragmode: 'pan',
                plot_bgcolor: 'rgba(255,255,255,0.9)', paper_bgcolor: 'rgba(255,255,255,0.9)',
                margin: { t: 50, b: 50, l: 60, r: 60 }
            };
            
            if(chartData.trades) {
                chartData.trades.forEach(trade => {
                    layout.annotations.push({
                        name: 'trade_marker', // Name for easy identification
                        x: trade.date, y: trade.price, xref: 'x', yref: 'y1', showarrow: true, arrowhead: trade.type === 'buy' ? 6 : 5, ax: 0, ay: trade.type === 'buy' ? -25 : 25,
                        bordercolor: trade.type === 'buy' ? '#27ae60' : '#c0392b', bgcolor: trade.type === 'buy' ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.7)',
                        text: trade.type === 'buy' ? 'B' : 'S', font: {color: 'white'}
                    });
                });
            }

            data = [candlestickTrace, portfolioTrace, benchmarkTrace];
            Plotly.newPlot('chartDiv', data, layout, { responsive: true, displayModeBar: true, modeBarButtonsToRemove: ['select2d', 'lasso2d'] });
            attachEventListeners();
            updateStatus();
        }

        function attachEventListeners() {
            const magnetBtn = document.getElementById('magnetBtn');
            const undoBtn = document.getElementById('undoBtn');
            const clearBtn = document.getElementById('clearBtn');
            const toggleAIBtn = document.getElementById('toggleAIBtn');
            const rangeButtons = document.querySelectorAll('.range-btn');

            magnetBtn.addEventListener('click', () => {
                magnetEnabled = !magnetEnabled;
                magnetBtn.classList.toggle('active', magnetEnabled);
                updateStatus();
            });

            toggleAIBtn.addEventListener('click', () => {
                isAIVisible = !isAIVisible;
                toggleAIBtn.classList.toggle('active', isAIVisible);
                
                // Toggle traces (AI portfolio and benchmark are at index 1 and 2)
                Plotly.restyle('chartDiv', { visible: isAIVisible }, [1, 2]);

                // Toggle trade annotations
                const annotationUpdates = {};
                layout.annotations.forEach((ann, i) => {
                    if (ann.name === 'trade_marker') {
                        annotationUpdates[`annotations[${i}].visible`] = isAIVisible;
                    }
                });
                if(Object.keys(annotationUpdates).length > 0) {
                    Plotly.relayout('chartDiv', annotationUpdates);
                }
            });

            rangeButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    rangeButtons.forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const range = e.currentTarget.dataset.range;
                    const endDate = new Date(chartData.dates[chartData.dates.length - 1]);
                    let startDate = new Date(chartData.dates[0]);
                    if (range !== 'all') {
                        startDate = new Date(endDate);
                        if (range === '1m') startDate.setMonth(startDate.getMonth() - 1);
                        else if (range === '3m') startDate.setMonth(startDate.getMonth() - 3);
                        else if (range === '6m') startDate.setMonth(startDate.getMonth() - 6);
                        else if (range === '1y') startDate.setFullYear(startDate.getFullYear() - 1);
                    }
                    Plotly.relayout('chartDiv', {
                        'xaxis.range': [startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0]]
                    });
                });
            });

            toolButtons.forEach(btn => btn.addEventListener('click', () => setActiveTool(btn.id.split('-').slice(1).join('-'))));
            
            clearBtn.addEventListener('click', () => {
                layout.shapes = layout.shapes.filter(s => s.drawing_id === undefined);
                layout.annotations = layout.annotations.filter(a => a.drawing_id === undefined && a.name !== 'trade_marker');
                Plotly.react('chartDiv', data, layout);
            });

            undoBtn.addEventListener('click', () => {
                const lastDrawingIdNum = Math.max(0, ...layout.shapes.map(s => parseInt(s.drawing_id?.split('-')[1] || 0)), ...layout.annotations.map(a => a.drawing_id?.split('-')[1] || 0));
                if (lastDrawingIdNum > 0) {
                    const drawingId = `drawing-${lastDrawingIdNum}`;
                    layout.shapes = layout.shapes.filter(s => s.drawing_id !== drawingId);
                    layout.annotations = layout.annotations.filter(a => a.drawing_id !== drawingId);
                } else {
                    if (layout.shapes.length > 0) layout.shapes.pop();
                    else if (layout.annotations.length > 0) layout.annotations.pop();
                }
                Plotly.react('chartDiv', data, layout);
            });

            chartDiv.on('plotly_relayout', (eventData) => {
                clearTimeout(relayoutTimeout);
                const isShapeEdit = Object.keys(eventData).some(k => k.startsWith('shapes['));

                if (currentTool) { // New shape creation
                    const lastShape = layout.shapes[layout.shapes.length - 1];
                    if (!lastShape) return;
                    const drawingId = `drawing-${drawingIdCounter++}`;
                    if (magnetEnabled) {
                        const snappedStart = findNearestCandlePoint(lastShape.x0, lastShape.y0);
                        const snappedEnd = findNearestCandlePoint(lastShape.x1, lastShape.y1);
                        lastShape.x0 = snappedStart.x; lastShape.y0 = snappedStart.y;
                        lastShape.x1 = snappedEnd.x; lastShape.y1 = snappedEnd.y;
                    }
                    lastShape.drawing_id = drawingId;
                    lastShape.editable = true;
                    switch(currentTool) {
                        case 'trendline': lastShape.name = 'trendline'; lastShape.line = { color: '#0066cc', width: 2 }; break;
                        case 'horizontal': lastShape.name = 'horizontal'; lastShape.y1 = lastShape.y0; lastShape.line = { color: '#ff6b6b', width: 2 }; break;
                        case 'vertical': lastShape.name = 'vertical'; lastShape.x1 = lastShape.x0; lastShape.line = { color: '#4ecdc4', width: 2 }; break;
                        case 'rectangle': lastShape.name = 'rectangle'; lastShape.line = { color: '#45b7d1', width: 2 }; lastShape.fillcolor = 'rgba(69, 183, 209, 0.1)'; break;
                        case 'fibonacci': case 'fibonacci-ext':
                            lastShape.name = currentTool === 'fibonacci' ? 'fib_bg' : 'fib_ext_bg';
                            lastShape.fillcolor = 'rgba(102, 126, 234, 0.1)';
                            lastShape.line = { width: 0 };
                            createFibonacci(lastShape, drawingId, currentTool === 'fibonacci-ext');
                            break;
                    }
                    setActiveTool(currentTool);
                    Plotly.react('chartDiv', data, layout);
                } else if (isShapeEdit) { // Existing shape edited
                    relayoutTimeout = setTimeout(() => {
                        const shapeKey = Object.keys(eventData).find(k => k.startsWith('shapes['));
                        if (!shapeKey) return;
                        const shapeIndex = parseInt(shapeKey.match(/\d+/)[0]);
                        const editedShape = layout.shapes[shapeIndex];
                        if (editedShape && editedShape.editable) {
                            if (magnetEnabled) {
                                const snappedStart = findNearestCandlePoint(editedShape.x0, editedShape.y0);
                                const snappedEnd = findNearestCandlePoint(editedShape.x1, editedShape.y1);
                                editedShape.x0 = snappedStart.x; editedShape.y0 = snappedStart.y;
                                editedShape.x1 = snappedEnd.x; editedShape.y1 = snappedEnd.y;
                            }
                            if (editedShape.name === 'fib_bg' || editedShape.name === 'fib_ext_bg') {
                                layout.shapes = layout.shapes.filter(s => s.drawing_id !== editedShape.drawing_id || s.name === editedShape.name);
                                layout.annotations = layout.annotations.filter(a => a.drawing_id !== editedShape.drawing_id);
                                createFibonacci(editedShape, editedShape.drawing_id, editedShape.name === 'fib_ext_bg');
                            }
                            Plotly.react('chartDiv', data, layout);
                        }
                    }, 150);
                }
            });

            chartDiv.on('plotly_hover', (e) => {
                const point = e.points[0];
                const priceText = point.close !== undefined ? `O:${point.open.toFixed(2)} H:${point.high.toFixed(2)} L:${point.low.toFixed(2)} C:${point.close.toFixed(2)}` : (point.y !== undefined ? point.y.toFixed(2) : '');
                coordinatesElement.innerHTML = `<strong>ë‚ ì§œ:</strong> ${point.x} | <strong>ê°€ê²©:</strong> ${priceText}`;
            });
            chartDiv.on('plotly_unhover', () => { coordinatesElement.innerHTML = 'ë§ˆìš°ìŠ¤ë¥¼ ì°¨íŠ¸ì— ì˜¬ë ¤ë³´ì„¸ìš”'; });
            chartDiv.on('plotly_click', (e) => {
                if (currentTool === 'text' && e.points.length > 0) {
                    let point = e.points[0];
                    if (magnetEnabled) {
                        const snapped = findNearestCandlePoint(point.x, point.y);
                        if (snapped.snapped) point = { x: snapped.x, y: snapped.y };
                    }
                    const text = prompt('ì¶”ê°€í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', 'ë¶„ì„ ë©”ëª¨');
                    if (text) {
                        const drawingId = `drawing-${drawingIdCounter++}`;
                        layout.annotations.push({ x: point.x, y: point.y, text: text, showarrow: true, arrowhead: 2, arrowsize: 1, arrowwidth: 2, arrowcolor: '#667eea', font: { size: 12, color: '#2c3e50' }, bgcolor: 'rgba(255,255,255,0.8)', bordercolor: '#667eea', borderwidth: 2, borderpad: 4, name: 'text_annotation', drawing_id: drawingId, editable: true });
                        setActiveTool(currentTool);
                        Plotly.react('chartDiv', data, layout);
                    }
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') { e.preventDefault(); undoBtn.click(); }
                    if (e.key === 'm') { e.preventDefault(); magnetBtn.click(); }
                }
                if (e.key === 'Escape') setActiveTool(null);
            });
            window.addEventListener('resize', () => Plotly.Plots.resize(chartDiv));
        }

        function findNearestCandlePoint(x, y) {
            if (!magnetEnabled || !chartData.dates) return { x, y, snapped: false };
            let closestDateIndex = 0, minDistance = Infinity;
            chartData.dates.forEach((date, index) => {
                const distance = Math.abs(new Date(x).getTime() - new Date(date).getTime());
                if (distance < minDistance) { minDistance = distance; closestDateIndex = index; }
            });
            const ohlcPrices = [chartData.open[closestDateIndex], chartData.high[closestDateIndex], chartData.low[closestDateIndex], chartData.close[closestDateIndex]];
            let closestPrice = ohlcPrices[0], minPriceDistance = Math.abs(closestPrice - y);
            ohlcPrices.forEach(price => {
                const distance = Math.abs(price - y);
                if (distance < minPriceDistance) { minPriceDistance = distance; closestPrice = price; }
            });
            return { x: chartData.dates[closestDateIndex], y: closestPrice, snapped: true };
        }

        function setActiveTool(toolName) {
            currentTool = (currentTool === toolName) ? null : toolName;
            toolButtons.forEach(btn => btn.classList.toggle('active', btn.id === `tool-${currentTool}`));
            let dragmode = 'pan';
            if (['trendline', 'horizontal', 'vertical', 'arrow'].includes(currentTool)) dragmode = 'drawline';
            else if (['rectangle', 'fibonacci', 'fibonacci-ext', 'channel'].includes(currentTool)) dragmode = 'drawrect';
            layout.dragmode = dragmode;
            Plotly.relayout('chartDiv', { dragmode: dragmode });
            updateStatus();
        }

        function updateStatus() {
            const statusElement = document.getElementById('tool-status');
            const magnetStatus = magnetEnabled ? ' (ğŸ§² ìì„ ON)' : ' (ìì„ OFF)';
            const messages = { null: 'ë„êµ¬ë¥¼ ì„ íƒí•˜ì—¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”' + magnetStatus, 'trendline': 'ë‘ ì ì„ í´ë¦­í•˜ì—¬ ì¶”ì„¸ì„ ì„ ê·¸ìœ¼ì„¸ìš”' + magnetStatus, 'horizontal': 'ìˆ˜í‰ì„ ì„ ê·¸ì„ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”' + magnetStatus, 'vertical': 'ìˆ˜ì§ì„ ì„ ê·¸ì„ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”' + magnetStatus, 'fibonacci': 'ë“œë˜ê·¸í•˜ì—¬ í”¼ë³´ë‚˜ì¹˜ ë˜ëŒë¦¼ ì˜ì—­ì„ ì„¤ì •í•˜ì„¸ìš”' + magnetStatus, 'fibonacci-ext': 'ë“œë˜ê·¸í•˜ì—¬ í”¼ë³´ë‚˜ì¹˜ í™•ì¥ ì˜ì—­ì„ ì„¤ì •í•˜ì„¸ìš”' + magnetStatus, 'rectangle': 'ë“œë˜ê·¸í•˜ì—¬ ì‚¬ê°í˜•ì„ ê·¸ìœ¼ì„¸ìš”' + magnetStatus, 'channel': 'ë“œë˜ê·¸í•˜ì—¬ ì±„ë„ì„ ì„¤ì •í•˜ì„¸ìš”' + magnetStatus, 'text': 'í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”' + magnetStatus, 'arrow': 'ë“œë˜ê·¸í•˜ì—¬ í™”ì‚´í‘œë¥¼ ê·¸ìœ¼ì„¸ìš”' + magnetStatus };
            statusElement.textContent = messages[currentTool] || messages.null;
        }

        function createFibonacci(rect, drawingId, isExtension) {
            const levels = isExtension ? fiboExtLevels : fiboLevels;
            const name_prefix = isExtension ? 'fib_ext' : 'fib';
            const y_start = Math.min(rect.y0, rect.y1);
            const y_end = Math.max(rect.y0, rect.y1);
            const y_diff = y_end - y_start;
            const descending = rect.y0 > rect.y1;
            levels.forEach((level, i) => {
                const level_y = descending ? y_end - y_diff * level : y_start + y_diff * level;
                layout.shapes.push({ type: 'line', x0: rect.x0, y0: level_y, x1: rect.x1, y1: level_y, line: { color: fiboColors[i % fiboColors.length], width: 1, dash: level === 0 || level === 1 ? 'solid' : 'dot' }, name: `${name_prefix}_line`, drawing_id: drawingId, editable: false });
                layout.annotations.push({ x: rect.x1, y: level_y, text: `${(level * 100).toFixed(1)}% (${level_y.toFixed(2)})`, showarrow: false, font: { color: fiboColors[i % fiboColors.length], size: 10 }, xanchor: 'left', yanchor: 'middle', name: `${name_prefix}_annotation`, drawing_id: drawingId });
            });
        }

        // On page load, fetch data and initialize the chart
        window.addEventListener('DOMContentLoaded', () => {
            // These are temporary hardcoded values for demonstration.
            // In a real application, you would get these from the user's selection on a previous page or URL parameters.
            initializeChart('AAPL', 'AAPL_ppo_20250911_001207.zip');
        });

    </script>