<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI TradingView - 분석</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: #000000;
            color: #ffffff;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            gap: 10px;
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-item {
            color: #ffffff;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .login-btn, .signup-btn {
            padding: 8px 20px;
            border: 2px solid #ffffff;
            background: transparent;
            color: #ffffff;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .login-btn:hover {
            background: #ffffff;
            color: #000000;
        }

        .signup-btn {
            background: #ffffff;
            color: #000000;
        }

        .signup-btn:hover {
            background: transparent;
            color: #ffffff;
        }

        .user-profile {
            display: none;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            background: rgba(255,255,255,0.1);
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ffffff;
            color: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sidebar {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 25px;
            height: fit-content;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .main-panel {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 25px;
            min-height: 600px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e5e5;
            margin-bottom: 25px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.95rem;
            color: #666666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            color: #000000;
            border-bottom-color: #000000;
            background: rgba(0,0,0,0.02);
        }

        .tab:hover {
            color: #000000;
            background: rgba(0,0,0,0.02);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #000000;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        .form-control:focus {
            outline: none;
            border-color: #000000;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
        }

        .form-control:hover {
            border-color: #cccccc;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: #000000;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #333333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: #ffffff;
            color: #000000;
            border: 1px solid #e5e5e5;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #cccccc;
        }

        .btn:disabled {
            background: #e5e5e5;
            color: #999999;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none;
        }

        /* Search Results */
        #symbolSearchResults {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-top: 10px;
            background: #ffffff;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        /* Results */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e5e5;
        }

        .metric-card h3 {
            font-size: 0.9rem;
            color: #666666;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .metric-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #000000;
        }

        .metric-card .value.positive {
            color: #16a085;
        }

        .metric-card .value.negative {
            color: #e74c3c;
        }

        /* Loading and Messages */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666666;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #000000;
        }

        .message-box {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .message-box.error {
            background: #ffe6e6;
            color: #cc0000;
            border: 1px solid #ffcccc;
        }

        .message-box.success {
            background: #e6ffe6;
            color: #008800;
            border: 1px solid #ccffcc;
        }

        /* Training Log */
        .training-log-container {
            margin-top: 20px;
        }

        .training-log-container h4 {
            margin-bottom: 15px;
            color: #000000;
            font-weight: 600;
        }

        #trainingLog {
            background: #f8f9fa;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* Divider */
        hr {
            border: none;
            height: 1px;
            background: #e5e5e5;
            margin: 25px 0;
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #16a085;
        }

        .status-indicator.offline {
            background: #e5e5e5;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .navbar {
                padding: 0 15px;
                height: 60px;
            }

            .nav-menu {
                gap: 15px;
            }

            .nav-item {
                display: none;
            }

            .container {
                padding: 20px 15px;
            }

            .tabs {
                flex-wrap: wrap;
            }
        }

        /* Dark mode support (for future) */
        @media (prefers-color-scheme: dark) {
            /* Will be implemented if needed */
        }

        /* Utility classes */
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-10 { gap: 10px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <nav class="navbar">
            <div class="logo"><i class="fas fa-chart-line"></i> AI TradingView</div>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-item">메인</a>
                <a href="{{ url_for('models_page') }}" class="nav-item">모델관리</a>
                <a href="{{ url_for('portfolio_page') }}" class="nav-item">포트폴리오</a>
                <a href="{{ url_for('analysis_page') }}" class="nav-item">분석</a>
                <a href="{{ url_for('stocks_page') }}" class="nav-item">종목보기</a>
            </div>
            <div class="user-menu">
                {% if current_user.is_authenticated %}
                <div class="user-profile" id="userProfile">
                    <a href="{{ url_for('profile') }}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 10px;">
                        <div class="status-indicator online"></div>
                        <div class="avatar">{{ current_user.name[0] }}</div>
                        <span>안녕하세요, {{ current_user.name }}님</span>
                    </a>
                    <a href="{{ url_for('logout') }}" class="login-btn">로그아웃</a>
                </div>
                {% else %}
                <div id="authButtons">
                    <a href="{{ url_for('login') }}" class="login-btn">로그인</a>
                    <a href="{{ url_for('register') }}" class="signup-btn">회원가입</a>
                </div>
                {% endif %}
            </div>
        </nav>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="sidebar">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('analyze')">
                        <i class="fas fa-chart-line"></i> 모델 분석
                    </button>
                    <button class="tab" onclick="showTab('train')">
                        <i class="fas fa-brain"></i> 알고리즘 개발
                    </button>
                </div>

                <div id="analyze-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="symbolSearch">종목 코드 검색</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="symbolSearch" class="form-control" placeholder="회사명 또는 종목 코드">
                            <button type="button" id="symbolSearchBtn" class="btn btn-secondary" style="width: auto; min-width: 50px;">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="symbolSearchResults"></div>
                    </div>

                    <hr>

                    <form id="analyzeForm">
                        <div class="form-group">
                            <label for="modelSelect">분석 모델 선택</label>
                            <select id="modelSelect" class="form-control" required></select>
                        </div>

                        <div class="form-group">
                            <label for="symbol">종목 코드</label>
                            <input type="text" id="symbol" class="form-control" placeholder="AAPL, GOOGL..." required>
                        </div>

                        <div class="form-group">
                            <label for="period">분석 기간</label>
                            <select id="period" class="form-control">
                                <option value="1mo">1개월</option>
                                <option value="3mo">3개월</option>
                                <option value="6mo" selected>6개월</option>
                                <option value="1y">1년</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="initialBalance">초기 자본 ($)</label>
                            <input type="number" id="initialBalance" class="form-control" value="10000" min="1000" step="1000">
                        </div>

                        <button type="submit" id="analyzeBtn" class="btn btn-primary">
                            <i class="fas fa-magic"></i> AI 분석 시작
                        </button>
                    </form>
                </div>

                <div id="train-tab" class="tab-content">
                    <form id="trainForm">
                        <div class="form-group">
                            <label for="trainSymbol">훈련용 종목 코드</label>
                            <input type="text" id="trainSymbol" class="form-control" placeholder="AAPL, GOOGL..." required>
                        </div>



                        <div class="form-group">
                            <label for="strategySelect">AI 전략 스타일</label>
                            <select id="strategySelect" class="form-control">
                                <option value="balanced" selected>균형형 (Balanced)</option>
                                <option value="conservative">안정형 (Conservative)</option>
                                <option value="aggressive">공격형 (Aggressive)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="trainModelName">모델 이름 지정</label>
                            <input type="text" id="trainModelName" class="form-control" placeholder="예: my_first_model" required>
                        </div>

                        <button type="submit" id="trainBtn" class="btn btn-primary">
                            <i class="fas fa-cogs"></i> 모델 훈련 시작
                        </button>
                    </form>
                </div>
            </div>

            <div class="main-panel" id="mainPanel">
                <div id="loadingDiv" class="loading" style="display: none;"></div>
                <div id="messageDiv" class="message-box" style="display: none;"></div>

                <div id="trainingLogContainer" class="training-log-container" style="display: none;">
                    <h4>훈련 로그</h4>
                    <div class="progress-bar-container" style="width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 10px;">
                        <div id="trainingProgressBar" style="width: 0%; height: 20px; background-color: #4caf50; border-radius: 5px; text-align: center; color: white; line-height: 20px;">0%</div>
                    </div>
                    <div id="trainingLog"></div>
                </div>

                <div id="resultsDiv" class="results-container" style="display: none;">
                    <div class="results-grid" id="metricsGrid"></div>
                    <div id="viewChartBtnContainer" class="text-center mt-20"></div>
                </div>

                <!-- Default Welcome Content -->
                <div id="welcomeContent">
                    <div class="text-center mb-20">
                        <h2 style="margin-bottom: 15px; color: #000000;">AI 모델 분석 및 개발</h2>
                        <p style="color: #666666; font-size: 1.1rem;">좌측 메뉴를 통해 모델을 분석하거나 새로운 AI를 훈련시켜보세요.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // All the script from index.html goes here
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            resetResultAreas();
        }

        function resetResultAreas() {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('messageDiv').style.display = 'none';
            document.getElementById('resultsDiv').style.display = 'none';
            document.getElementById('trainingLogContainer').style.display = 'none';
            document.getElementById('welcomeContent').style.display = 'block';
        }

        function showMessage(message, type = 'error') {
            const messageDiv = document.getElementById('messageDiv');
            messageDiv.textContent = message;
            messageDiv.className = `message-box ${type}`;
            messageDiv.style.display = 'block';
            document.getElementById('welcomeContent').style.display = 'none';
        }

        function setLoading(isLoading, buttonId, message) {
            const button = document.getElementById(buttonId);
            const loadingDiv = document.getElementById('loadingDiv');
            if (isLoading) {
                resetResultAreas();
                loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i><h3>${message}</h3>`;
                loadingDiv.style.display = 'block';
                document.getElementById('welcomeContent').style.display = 'none';
                if (button) button.disabled = true;
            } else {
                loadingDiv.style.display = 'none';
                if (button) button.disabled = false;
            }
        }

        async function loadModels() {
            try {
                const response = await fetch('/model');
                if (!response.ok) {
                    throw new Error('서버에서 모델 목록을 가져오는 데 실패했습니다.');
                }
                const models = await response.json();
                const modelSelect = document.getElementById('modelSelect');
                modelSelect.innerHTML = '';
                if (models.length === 0) {
                    modelSelect.innerHTML = '<option value="">사용 가능한 모델이 없습니다. 먼저 모델을 훈련시켜주세요.</option>';
                } else {
                    models.forEach(model => {
                        const optionText = `${model.filename} (종목: ${model.symbol}, 전략: ${model.strategy})`;
                        const optionValue = model.filename;
                        const option = new Option(optionText, optionValue);
                        // 데이터 속성에 추가 정보 저장
                        option.dataset.strategy = model.strategy;
                        option.dataset.symbol = model.symbol;
                        modelSelect.add(option);
                    });
                }
            } catch (err) {
                showMessage('모델 목록을 불러오는 데 실패했습니다, 로그인 여부를 확인해 주십시오.: ' + err.message);
            }
        }

        let searchTimeout;
        async function searchSymbols() {
            const query = document.getElementById('symbolSearch').value;
            const resultsContainer = document.getElementById('symbolSearchResults');
            if (query.length < 1) {
                resultsContainer.innerHTML = '';
                resultsContainer.style.display = 'none';
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                resultsContainer.innerHTML = '<div class="search-result-item">검색 중...</div>';
                resultsContainer.style.display = 'block';

                try {
                    const response = await fetch(`/api/search_us_stock?query=${encodeURIComponent(query)}`);
                    const results = await response.json();
                    
                    resultsContainer.innerHTML = '';
                    if (results.length > 0) {
                        results.forEach(stock => {
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `<strong>${stock.ticker}</strong> - ${stock.name}`;
                            item.onclick = () => {
                                document.getElementById('symbol').value = stock.ticker;
                                document.getElementById('trainSymbol').value = stock.ticker;
                                resultsContainer.innerHTML = '';
                                resultsContainer.style.display = 'none';
                            };
                            resultsContainer.appendChild(item);
                        });
                    } else {
                        resultsContainer.innerHTML = '<div class="search-result-item">검색 결과가 없습니다.</div>';
                    }
                } catch (err) {
                    resultsContainer.innerHTML = `<div class="search-result-item">검색 오류: ${err.message}</div>`;
                }
            }, 300);
        }

        function displaySingleResult(result) {
            const resultsDiv = document.getElementById('resultsDiv');
            const metricsGrid = document.getElementById('metricsGrid');
            const chartBtnContainer = document.getElementById('viewChartBtnContainer');
            
            document.getElementById('welcomeContent').style.display = 'none';
            metricsGrid.innerHTML = '';

            const formatPercent = (val) => `${(val * 100).toFixed(2)}%`;
            const formatCurrency = (val) => `$${val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const metrics = [
                { label: '초기 자본', value: formatCurrency(result.initial_balance) },
                { label: '최종 자산', value: formatCurrency(result.final_balance), isPositive: result.final_balance > result.initial_balance },
                { label: 'AI 총 수익률', value: formatPercent(result.total_return), isPositive: result.total_return > 0 },
                { label: '벤치마크 수익률', value: formatPercent(result.benchmark_return), isPositive: result.benchmark_return > 0 },
                { label: '총 거래 횟수', value: result.total_trades },
                { label: '오늘의 AI 추천', value: result.todays_action, isAction: true, action: result.todays_action }
            ];

            metrics.forEach(metric => {
                if (!metric.value) return;
                const card = document.createElement('div');
                card.className = 'metric-card';
                let valueClass = 'value';
                if (metric.isPositive === true) valueClass += ' positive';
                if (metric.isPositive === false) valueClass += ' negative';
                if (metric.isAction) {
                    if (metric.action === '매수') valueClass += ' positive';
                    else if (metric.action === '매도') valueClass += ' negative';
                }
                
                card.innerHTML = `
                    <h3>${metric.label}</h3>
                    <div class="${valueClass}">${metric.value}</div>
                `;
                metricsGrid.appendChild(card);
            });

            chartBtnContainer.innerHTML = '';
            if (result.chart_data) {
                const chartBtn = document.createElement('button');
                chartBtn.className = 'btn btn-secondary';
                chartBtn.innerHTML = '<i class="fas fa-chart-area"></i> 상세 차트 보기';
                chartBtn.onclick = () => {
                    localStorage.setItem('chartData', JSON.stringify(result.chart_data));
                    window.open('/chart', '_blank');
                };
                chartBtnContainer.appendChild(chartBtn);
            }

            resultsDiv.style.display = 'block';
        }

        let isTraining = false;

        function beforeUnloadHandler(e) {
            if (isTraining) {
                e.preventDefault();
                e.returnValue = ''; // Chrome requires returnValue to be set.
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadModels();
            
            document.getElementById('symbolSearchBtn').addEventListener('click', searchSymbols);
            document.getElementById('symbolSearch').addEventListener('keyup', (e) => {
                searchSymbols();
            });

            document.getElementById('analyzeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const buttonId = 'analyzeBtn';
                setLoading(true, buttonId, 'AI가 주식을 분석하고 있습니다...');

                const modelSelect = document.getElementById('modelSelect');
                const selectedOption = modelSelect.options[modelSelect.selectedIndex];

                const payload = {
                    model_name: modelSelect.value,
                    symbol: document.getElementById('symbol').value,
                    period: document.getElementById('period').value,
                    initial_balance: parseFloat(document.getElementById('initialBalance').value),
                    strategy: selectedOption.dataset.strategy || 'balanced' // 데이터 속성에서 전략 가져오기
                };

                // 모델에 지정된 종목으로 자동 설정
                if (selectedOption.dataset.symbol) {
                    document.getElementById('symbol').value = selectedOption.dataset.symbol;
                    payload.symbol = selectedOption.dataset.symbol;
                }

                if (!payload.model_name || payload.model_name === '') {
                    setLoading(false, buttonId);
                    return showMessage('분석할 모델을 선택해주세요.');
                }
                if (!payload.symbol) {
                    setLoading(false, buttonId);
                    return showMessage('종목 코드를 입력해주세요.');
                }

                try {
                    const response = await fetch('/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || '분석 중 오류가 발생했습니다.');
                    }
                    
                    localStorage.setItem('analysisResult', JSON.stringify(result));
                    displaySingleResult(result);

                } catch (err) {
                    showMessage('분석 API 호출 오류: ' + err.message);
                } finally {
                    setLoading(false, buttonId);
                }
            });

            document.getElementById('trainForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                isTraining = true;
                window.addEventListener('beforeunload', beforeUnloadHandler);

                const buttonId = 'trainBtn';
                const logContainer = document.getElementById('trainingLogContainer');
                const logDiv = document.getElementById('trainingLog');
                const button = document.getElementById(buttonId);

                button.disabled = true;
                resetResultAreas();
                logContainer.style.display = 'block';
                document.getElementById('welcomeContent').style.display = 'none';
                logDiv.innerHTML = '';

                const payload = {
                    symbol: document.getElementById('trainSymbol').value,
                    period: '10y', // 기간 고정
                    model_name: document.getElementById('trainModelName').value,
                    strategy: document.getElementById('strategySelect').value
                };
                
                if (!payload.symbol || !payload.model_name) {
                    button.disabled = false;
                    isTraining = false;
                    window.removeEventListener('beforeunload', beforeUnloadHandler);
                    return showMessage('훈련할 종목 코드와 모델 이름을 모두 입력해주세요.');
                }

                try {
                    const response = await fetch('/train', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.body) {
                        throw new Error('스트리밍 응답을 지원하지 않습니다.');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n').filter(line => line.trim() !== '');

                        lines.forEach(line => {
                            try {
                                const data = JSON.parse(line);
                                const progressBar = document.getElementById('trainingProgressBar');
                                if (data.status === 'progress_update') {
                                    progressBar.style.width = `${data.percentage}%`;
                                    progressBar.textContent = `${data.percentage}%`;
                                }
                                const logEntry = document.createElement('div');
                                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${data.message}`;
                                if (data.status === 'error') {
                                    logEntry.style.color = 'red';
                                } else if (data.status === 'success') {
                                    logEntry.style.color = 'green';
                                    logEntry.style.fontWeight = 'bold';
                                    loadModels();
                                }
                                logDiv.appendChild(logEntry);
                                logDiv.scrollTop = logDiv.scrollHeight;
                            } catch (e) {
                                console.warn('로그 파싱 오류:', line, e);
                            }
                        });
                    }
                } catch (err) {
                    showMessage('훈련 중 오류가 발생했습니다: ' + err.message);
                } finally {
                    button.disabled = false;
                    isTraining = false;
                    window.removeEventListener('beforeunload', beforeUnloadHandler);
                }
            });
        });
    </script>
</body>
</html>